---
layout: post
author: "杨小定定"
title:  "DB2 权限管理"
description: "简单讨论和记录DB2的用户、安全模型、授予和撤销权限。"
date:   2018-03-05 14:05:00 +0800
categories: technology
---

## 用户

我们可以看到，安装完DB2之后，必须先创建如下三个用户才能进行建库和建立管理服务器。

| 用户作用 | 用户名 | 组名 |
|:--- |:--- |:--- |
| 实例所有者 | `db2inst1` | `db2iadm1` |
| 受保护用户 | `db2fenc1` | `db2fadm1` |
| 管理服务器用户 | `dasusr1` | `dbasdm1` |

关于它们分别的作用，我们来看一下：

* `db2inst1`：**实例所有者**，DB2实例是在实例所有者主目录中创建的。此用户控制所有DB2进程并拥有由包含在该实例中的数据库所使用的所有文件系统和设备。缺省用户为`db2inst1`，缺省组为`db2iadm1`。当使用DB2安装向导时，缺省的操作是为DB2实例创建一个新用户`db2inst1`，如果此用户名已存在，则DB2将尝试创建另一个用户名`db2inst2`。如果这个用户名也存在，DB2将继续搜索用户名`db2inst3`、`db2inst4`等等，直到它标识出系统上不是现有用户的第一个用户名作为缺省的实例所有者ID。
* `db2fenc1`：**受防护的用户**，受防护的用户用于在DB2数据库所使用的地址空间之外运行用户定义的函数（UDF）和存储过程。缺省用户为`db2fenc1`，缺省组为`db2fadm1`。如果不需要此安全级别（例如，在测试环境中），则可以使用实例所有者作为受防护的用户。
* `dasusr1`：**DB2管理服务器用户**，缺省用户为`dasusr1`，缺省组为`dasadm1`。DB2 GUI工具也会使用此用户标识来对本地服务器数据库实例和数据库执行管理任务。此用户不包含任何数据库，且每台机器仅有一个管理服务器。例如，一个管理服务器可以服务多个数据库实例。

## DB2安全性模型

安全性采用两种方式来控制对 DB2® 数据库系统数据和函数的访问。

对DB2数据库系统的访问由位于DB2数据库系统外部的工具来管理（认证），而DB2数据库系统内的访问由数据库管理器管理（授权）。

### 认证

认证就是系统验证用户身份的过程。用户认证是由DB2数据库系统外部的安全性工具通过认证安全插件模块来完成的。

当您安装DB2数据库系统时就包括了依赖于基于操作系统的认证的缺省认证安全插件模块。为方便起见，DB2数据库管理器还提供了用于Kerberos和轻量级目录访问协议（LDAP）的认证插件模块。为了更灵活地适应您特定的认证需要，可以构建您自己的认证安全插件模块。

认证过程将生成一个DB2授权标识。用户的组成员资格信息也是在认证期间获得的。缺省情况下获得的组信息依赖于当您安装DB2数据库系统时包括的依赖于基于操作系统的组成员资格插件模块。如果愿意，可以通过使用特定的组成员资格插件模块（如 LDAP）来获取组成员资格信息。

### 权限

对用户进行认证之后，数据库管理器就会确定是否允许该用户访问DB2数据或资源。

授权是这样一个过程：DB2数据库管理器通过此过程来获取有关已认证的用户的信息，指示该用户可以执行哪些数据库操作，该用户可以访问哪些数据对象。

以下是可用于授权标识的许可权的不同来源：

1. 主要许可权：直接授予授权标识的许可权。
2. 辅助许可权：授予该授权标识作为其成员的组和角色的许可权。
3. 公用许可权：授予 PUBLIC 的许可权。
4. 上下文敏感许可权：授予可信上下文角色的那些许可权。

可以按下列类别将权限授予用户：

* 系统级别权限  
  系统管理员（SYSADM）、系统控制（SYSCTRL）、系统维护（SYSMAINT）和系统监视（SYSMON）权限提供了不同程度的对实例级别函数的控制权。权限提供一种方法来对特权分组和控制实例、数据库和数据库对象的维护和实用程序操作。
* 数据库级别权限  
  安全性管理员 (SECADM)、数据库管理员 (DBADM)、数据库访问控制 (ACCESSCTRL)、数据库的数据访问 (DATAACCESS)、SQL 管理员 (SQLADM)、工作负载管理的管理员 (WLMADM) 以及说明（EXPLAIN）权限提供了数据库内的控制权。其他数据库权限包括 LOAD（能够将数据装入到表中）和 CONNECT（能够连接至数据库）。
* 对象级别权限  
  对象级别权限涉及对对象执行操作时检查特权。例如，要从表中进行选择，用户就必须至少对该表具有 SELECT 特权。
* 基于内容的权限  
  通过视图可以控制特定用户可以读取一个表中的哪些列或行。基于标号的访问控制 (LBAC) 确定哪些用户对各行和各列具有读写访问权。

可以将这些功能和DB2审计设施一起用来监视访问，定义和管理数据库安装需要的安全级别。

## 权限，特权和对象所有权

仅当用户（由授权标识标识）具有执行指定函数的权限时，他们才能成功执行操作。要创建表，必须授权用户创建表；要改变表，必须授权用户改变表；等等。

数据库管理器要求对每个用户特别授权，以使用执行特定任务所需的每个数据库函数。用户可以获取必需权限的方式如下：通过对其用户标识授予该权限，或借助拥有该权限的角色或组的成员资格。

存在三种形式的权限：*管理权限*、*特权*和*LBAC凭证*。此外，对象的所有权会带给它对所创建对象的某种程度的权限。

### 管理权限

拥有管理权限的人管理控制数据库管理器的任务并负责数据的安全性和完整性。

#### 系统级别权限

系统级别权限提供了不同程度的对实例级别函数的控制权：

* SYSADM（系统管理员）权限  
  SYSADM（系统管理员）权限提供了对数据库管理器所创建和维护的全部资源的控制权。系统管理员拥有下列全部权限：SYSCTRL、SYSMAINT 和 SYSMON 权限。具有 SYSADM 权限的用户负责控制数据库管理器并确保数据的安全和完整性。
* SYSCTRL 权限  
  SYSCTRL 权限提供了对影响系统资源的操作的控制权。例如，具有 SYSCTRL 权限的用户可以创建、更新、启动、停止或删除数据库。此用户还可以启动或停止实例，但不能访问表数据。具有 SYSCTRL 权限的用户还具有 SYSMON 权限。
* SYSMAINT 权限  
  SYSMAINT 权限提供在所有与实例关联的数据库上执行维护操作所需的权限。具有 SYSMAINT 权限的用户可以更新数据库配置、备份数据库或表空间、复原现有数据库并监视数据库。类似于 SYSCTRL，SYSMAINT 不提供对表数据的访问。具有 SYSMAINT 权限的用户也具有 SYSMON 权限。
* SYSMON（系统监视）权限  
  SYSMON（系统监视）权限提供使用数据库系统监视器所需的权限。

#### 数据库级别权限

数据库级别权限提供了数据库内的控制权：

* DBADM（数据库管理员）  
  DBADM 权限级别提供对单个数据库的管理权限。此数据库管理员拥有创建对象和发出数据库命令所需的特权。  
  DBADM 权限只能由具有 SECADM 权限的用户授予。不能将 DBADM 权限授予 PUBLIC。
* SECADM（安全性管理员）  
  SECADM 权限级别针对安全性提供对单个数据库的管理权限。安全性管理员权限能够管理数据库安全性对象（数据库角色、审计策略、可信上下文、安全标号组件和安全标号）以及授予和撤销所有数据库特权和权限。具有 SECADM 权限的用户可以转移不属于他们的对象的所有权。他们可以使用 AUDIT 语句将审计策略与服务器中的特定数据库或数据库对象关联。  
  SECADM 权限没有访问存储在表中的数据的固有特权。它只能由具有 SECADM 权限的用户授予。不能将 SECADM 权限授予 PUBLIC。
* SQLADM（SQL 管理员）  
  SQLADM 权限级别提供在单个数据库内监视和调整 SQL 语句的管理权限。它可由具有 ACCESSCTRL 或 SECADM 权限的用户授予。
* WLMADM（工作负载管理管理员）  
  WLMADM 权限提供管理工作负载管理对象（如服务类、工作操作集、工作类集以及工作负载）的管理权限。它可由具有 ACCESSCTRL 或 SECADM 权限的用户授予。
* EXPLAIN（说明权限）  
  EXPLAIN 权限级别提供在没有获得数据访问权的情况下说明查询方案的管理权限。它只能由具有 ACCESSCTRL 或 SECADM 权限的用户授予。
* ACCESSCTRL（数据库访问控制权限）  
  ACCESSCTRL 权限级别提供发出以下 GRANT（和 REVOKE）语句的管理权限。
  * GRANT（数据库权限）  
   ACCESSCTRL 权限不会使拥有者能够授予 ACCESSCTRL、DATAACCESS、DBADM 或 SECADM 权限。只有具有 SECADM 权限的用户才能授予这些权限。
  * GRANT（全局变量特权）  
  * GRANT（索引特权）  
  * GRANT（模块特权）  
  * GRANT（程序包特权）  
  * GRANT（例程特权）  
  * GRANT（模式特权）  
  * GRANT（序列特权）  
  * GRANT（服务器特权）  
  * GRANT（表、视图或昵称特权）  
  * GRANT（表空间特权）  
  * GRANT（工作负载特权）  
  * GRANT（XSR 对象特权）  
* ACCESSCTRL 权限只能由具有 SECADM 权限的用户授予。不能将 ACCESSCTRL 权限授予 PUBLIC。  
* DATAACCESS（数据库的数据访问权限）  
  DATAACCESS 权限级别提供下列特权和权限。
  * LOAD 权限  
  * 对表、视图、昵称和具体化查询表的 SELECT、INSERT、UPDATE 和 DELETE 特权  
  * 对程序包的 EXECUTE 特权  
  * 对模块的 EXECUTE 特权  
  * 对例程的 EXECUTE 特权  
   对下列审计例程除外：AUDIT_ARCHIVE、AUDIT_LIST_LOGS 和 AUDIT_DELIM_EXTRACT。
  * 对所有全局变量的 READ 特权和 对除只读变量外的所有全局变量的 WRITE 特权  
  * 对所有 XSR 对象的 USAGE 特权  
  * 对所有序列的 USAGE 特权  
* 它只能由拥有 SECADM 权限的用户授予。不能将 DATAACCESS 权限授予 PUBLIC。  
* 数据库权限（非管理）  
  要执行诸如创建表或例程，或者用于将数据装入表等的活动，需要特定数据库权限。例如，使用 load 实用程序将数据装入到表中需要 LOAD 数据库权限（用户还必须具有在表中插入数据的特权）。

## 授予和撤销访问权

### 授予特权

要授予对大多数数据库对象的特权，必须对该对象具有 ACCESSCTRL 权限、SECADM 权限或 CONTROL 特权；

或者，必须拥有特权 WITH GRANT OPTION。

此外，具有 SYSADM 或 SYSCTRL 权限的用户可以授予表空间特权。

只能授予对现有对象的特权。

#### 关于此任务

要将 CONTROL 特权授予其他用户，必须具有 ACCESSCTRL 或 SECADM 权限。

要授予 ACCESSCTRL、DATAACCESS、DBADM 或 SECADM 权限，必须具有 SECADM 权限。

GRANT 语句允许授权用户授予特权。可以在一条语句中将一个特权授予一个或多个授权名；或授予 PUBLIC，这使该特权可供所有用户使用。注意授权名可以是个别用户，也可以是组。

在存在具有相同名称的用户和组的操作系统上，应当指定是将该特权授予用户还是授予组。

GRANT 和 REVOKE 语句都支持关键字 USER、GROUP 和 ROLE。如果未使用这些可选的关键字，那么数据库管理器会检查操作系统安全性工具，以确定授权名是标识用户还是组；它还检查是否存在同名且类型为角色的授权标识。

如果数据库管理器无法确定授权名是否引用用户、组或角色，那么会返回错误。

以下示例将 EMPLOYEE 表的 SELECT 特权授予用户 HERON：

```
GRANT SELECT ON EMPLOYEE TO USER HERON
```

以下示例将 EMPLOYEE 表的 SELECT 特权授予组 HERON：
```
GRANT SELECT ON EMPLOYEE TO GROUP HERON
```

GRANT 数据库授权语法（其它类似）：

```
>>-GRANT-------------------------------------------------------->

   .-,------------------------------------------------------------------.   
   V                                                                    |   
>----+-ACCESSCTRL-----------------------------------------------------+-+-->
     +-BINDADD--------------------------------------------------------+     
     +-CONNECT--------------------------------------------------------+     
     +-CREATETAB------------------------------------------------------+     
     +-CREATE_EXTERNAL_ROUTINE----------------------------------------+     
     +-CREATE_NOT_FENCED_ROUTINE--------------------------------------+     
     +-CREATE_SECURE_OBJECT-------------------------------------------+     
     +-DATAACCESS-----------------------------------------------------+     
     |           .-WITH DATAACCESS----.     .-WITH ACCESSCTRL----.    |     
     +-DBADM--•--+--------------------+--•--+--------------------+--•-+     
     |           '-WITHOUT DATAACCESS-'     '-WITHOUT ACCESSCTRL-'    |     
     +-EXPLAIN--------------------------------------------------------+     
     +-IMPLICIT_SCHEMA------------------------------------------------+     
     +-LOAD-----------------------------------------------------------+     
     +-QUIESCE_CONNECT------------------------------------------------+     
     +-SECADM---------------------------------------------------------+     
     +-SQLADM---------------------------------------------------------+     
     '-WLMADM---------------------------------------------------------'     

                    .-,---------------------------------.   
                    V                                   |   
>--ON DATABASE--TO----+-+-------+--authorization-name-+-+------><
                      | +-USER--+                     |     
                      | +-GROUP-+                     |     
                      | '-ROLE--'                     |     
                      '-PUBLIC------------------------'
```

### 撤销特权

REVOKE 语句允许授权用户撤销先前已授予其他用户的特权。

#### 关于此任务

要撤销对数据库对象的特权，必须对该对象具有 ACCESSCTRL 权限、SECADM 权限或 CONTROL 特权。

表空间特权还可以由具有 SYSADM 和 SYSCTRL 权限的用户撤销。注意，持有使用 WITH GRANT OPTION 授予的特权并不足以撤销该特权。

要撤销另一个用户的 CONTROL 特权，必须具有 ACCESSCTRL 或 SECADM 权限。

要撤销 ACCESSCTRL、DATAACCESS、DBADM 或 SECADM 权限，必须具有 SECADM 权限。

表空间特权只能由拥有 SYSADM 或 SYSCTRL 权限的用户撤销。

只能撤销对现有对象的特权。

> 不具有 ACCESSCTRL 权限、SECADM 权限或 CONTROL 特权的用户不能撤销他们使用 WITH GRANT OPTION 授予的特权。另外，由被撤销特权的人授予特权的那些人不会被撤销特权。

如果撤销用户（具有 DBADM 权限）的显式授予的表（或视图）特权，那么将不会从在该表上定义的其他视图撤销特权。这是因为视图特权可通过 DBADM 权限得到，并不依赖于基础表上的显式特权。

如果已将特权授予名称相同的用户、组或角色，那么当撤销此特权时必须指定 GROUP、USER 或 ROLE 关键字。

以下示例从用户 HERON 撤销对 EMPLOYEE 表的 SELECT 特权：

```
REVOKE SELECT ON EMPLOYEE FROM USER HERON
```

以下示例从组 HERON 撤销对 EMPLOYEE 表的 SELECT 特权：

```
REVOKE SELECT ON EMPLOYEE FROM GROUP HERON
```

注意从一个组中撤销特权并不能从该组的所有成员中撤销该特权。如果个别名称已被直接授予一个特权，那么此名称将保留它，直到被直接撤销该特权为止。

如果从一个用户撤销了表特权，那么也撤销对该用户创建的任何视图的特权，这取决于已撤销的表特权。但是，只撤销系统隐式授予的那些特权。如果该视图的一个特权是另一个用户直接授予的，那么此特权仍然会被保留。

如果从一个用户撤销了表特权，那么也撤销对该用户创建的任何视图的特权，这取决于已撤销的表特权。但是，只撤销系统隐式授予的那些特权。如果该视图的一个特权是另一个用户直接授予的，那么此特权仍然会被保留。

您可能会遇到这样的情况，您想要将一种特权授予一个组，然后仅从组中的其中一个成员撤销该特权。仅有两种方式执行该操作而不会接收到错误消息 SQL0556N：

* 您可以从组中除去该成员；或者创建具有较少成员的新组，并将特权授予新组。
* 可以从组中撤销特权，然后将特权授予个别用户（授权标识）。

> 当从一个用户撤销对一个表或视图的 CONTROL 特权时，此用户仍然能够将特权授予其他用户。当授予 CONTROL 特权时，用户也可接收使用 WITH GRANT OPTION 提供的所有其他特权。一旦撤销了 CONTROL，那么使用 WITH GRANT OPTION 提供的所有其他特权会保留，一直到显式撤销它们为止。

取决于被撤销的特权的所有程序包都标记为无效，但是如果一个具有合适权限的用户重新绑定它们，那么可以变得有效。如果随后又将特权授予应用程序的绑定者，也可以重建程序包；运行此应用程序将触发一个成功的隐式重新绑定。

如果从 PUBLIC 撤销了特权，那么所有由只能根据 PUBLIC 特权绑定的用户绑定的程序包都无效。

如果从用户撤销了 DBADM 权限，那么该用户绑定的所有程序包全都无效，包括与数据库实用程序相关的那些程序包。试图使用标记为无效的程序包将引起系统试图重新绑定此程序包。如果此重新绑定尝试失败，那么发生错误（SQLCODE -727）。在此情况下，必须由具有如下权限的用户显式地重新绑定程序包：

* 重新绑定程序包的权限
* 对程序包中使用的对象的适当权限
* 应当在撤销特权时重新绑定这些程序包。

如果根据一个或多个特权定义触发器或 SQL 函数，并且失去了这些特权中的一个或多个特权，那么不能使用该触发器或 SQL 函数。

REVOKE 数据库授权语法（其它类似） ：

```
           .-,-----------------------------.                
           V                               |                
>>-REVOKE----+-ACCESSCTRL----------------+-+--ON DATABASE------->
             +-BINDADD-------------------+                  
             +-CONNECT-------------------+                  
             +-CREATETAB-----------------+                  
             +-CREATE_EXTERNAL_ROUTINE---+                  
             +-CREATE_NOT_FENCED_ROUTINE-+                  
             +-CREATE_SECURE_OBJECT------+                  
             +-DBADM---------------------+                  
             +-DATAACCESS----------------+                  
             +-EXPLAIN-------------------+                  
             +-IMPLICIT_SCHEMA-----------+                  
             +-LOAD----------------------+                  
             +-QUIESCE_CONNECT-----------+                  
             +-SECADM--------------------+                  
             +-SQLADM--------------------+                  
             '-WLMADM--------------------'                  

         .-,---------------------------------.               
         V                                   |  .-BY ALL-.   
>--FROM----+-+-------+--authorization-name-+-+--+--------+-----><
           | +-USER--+                     |                 
           | +-GROUP-+                     |                 
           | '-ROLE--'                     |                 
           '-PUBLIC------------------------'
```
